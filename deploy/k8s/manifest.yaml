---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-iscsi-home-assistant-db
spec:
  storageClassName: "freenas-iscsi-manual-csi"
  capacity:
    storage: 30Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: org.democratic-csi.node-manual
    readOnly: false
    fsType: xfs
    volumeHandle: pv-iscsi-home-assistant-db
    volumeAttributes:
      portal: storage-server.lan:3260
      iqn: iqn.2005-10.org.freenas.ctl:home-assistant-db
      lun: "0"
      node_attach_driver: iscsi
      provisioner_driver: node-manual
---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-nfs-home-assistant-config
spec:
  storageClassName: "freenas-nfs-manual-csi"
  capacity:
    storage: 20Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  mountOptions:
    - nfsvers=4
    - nolock
    - noatime
  csi:
    driver: org.democratic-csi.node-manual
    readOnly: false
    fsType: nfs
    volumeHandle: pv-nfs-home-assistant-config
    volumeAttributes:
      server: storage-server.lan
      share: /mnt/r10_8tb/k8s/home-assistant-config/.storage/
      node_attach_driver: nfs
      provisioner_driver: node-manual
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-iscsi-home-assistant-db
  namespace: home-automation
  annotations:
    volume.beta.kubernetes.io/storage-class: "freenas-iscsi-manual-csi"
spec:
  storageClassName: freenas-iscsi-manual-csi
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 30Gi
  volumeName: pv-iscsi-home-assistant-db
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-nfs-home-assistant-config
  namespace: home-automation
  annotations:
    volume.beta.kubernetes.io/storage-class: "freenas-nfs-manual-csi"
spec:
  storageClassName: freenas-nfs-manual-csi
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 20Gi
  volumeName: pv-nfs-home-assistant-config
---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: home-assistant-mysql-secrets
  namespace: home-automation
spec:
  template:
    type: Opaque
    metadata:
      name: home-assistant-mysql-secrets
      namespace: home-automation
      labels:
        app.kubernetes.io/name: home-assistant
  encryptedData:
    mysql-password: AgBT6ulgx3DmQ0fxlVzEXZn1AzOQboc6EY9lyRgUUEu1nYaCb/sX9lU68v5L5hMsqE3Lk45ylD01I1C7VLvfw4ic1hZoyLJ9T/+WdE/EA/4mxOBviz02ghDM8d0CxFiLoLfBPctG8tXQbSNihNYDn0x15kO4QlVVD7/XZhUhTw1lr1GsvSikailLlfPgly3hljjBN/C3ymBqqEj/pmO+h2wcFyMavrI6Wm5XgKJV76e5HgQAyYv9CSGJ4WKSM8e8Gr60rRNmLnv7wU1thvrj/VkMK9IjIyy/EogwgDHWVtefrWDh/+upf+tezzP/PjtiEFrOYAea2xFZzxZ1PI6Trc/TpI0CZneDE1bHdysbZXW08hDWxjcR2KS8N08VR5LUriAT+QMa4TnPE9d6UrYZ6zgaJ+7vVawWxlj8Zrm+de7bMzSpVvZQRXrTqKWLOS8BpmuW8PDywyZJfssARFKO8sXJXMH7ZTdbG7IJJZi9kSdsDe/3SG2MutZCb5H+xrodftVSgtXeM+Oe1U37sjYWRnK8msdODo1OsRFkvHrTleUaOtVWvB3G6dF6FHxhlUgmBfLukFFMm6G6qM1IL3UQIXoyXcwGguv8EEKBmE8kl1xxAFPL/T1zIb+uSVg26V75/LvliNh/BJzIsTo9qiEEYVbXjy1y5xEymqa8x1I/Hp45uEq/+8eE6pEY90b7+YUjg+MmbEQIrsOIf/7IU4f9lMlBysSTbYmDo6yqq8rAeAwHCg==
    mysql-username: AgDnFG/NLagy/LUox/nruL9HjgLHuK0btprgiyvunB3e7IVc4gYfF1TLcByW4eZK3LqkJ01eVvMgtInMzgl8oRgPwZ4HfxnxkOPQb2kCyyAIfz61DfgOq3bSt/gXcV4+XrCR5/bRLLddz+mBDEQ+h1mXoqSJm0qaVmILI4YtMQTyhk2Py0Vbe6H9vWjOCYYvjKOxu7C+1qIsj0FzjNxCj/hfugL3AjpGPWQ/NY7ovu5QSlYT/jLaZeX1muRM/VrciV9zArpoZ82T8tFheDIXzbd2K7301Zh77MdnedISokEBCYWnJxa7wVnKLYL+eCC+J2xj0NmkvNg9afuu3KqP1+eOoZYxeFAnHWvAAdTYu6e0wgc2wJdSDgQio+eVzSswSCBQxMlFrS+y6DDZEytlF2mwEAEOwe1xKpTZm5n5/PIDBAthv1SHiFryLJFKmNN+LgEM9j19x2kV7pK5u2GqwWH+H5QpvZas0RN41SIiSWCZ1mEPZGMPKdrpdaXKVdrRSOVH/Ez98dUoB7UMV27OooWLIcdmPUK0C6V9SdsAnGhEA+3aGOjyIGs2/womVjvKoo1ivjhZVOxfQEkmreLYZzesRUGUJUjkVjLG5BEjXYrNLE/MEMGQn8X0Xnh3rkszaWMeyLCZDVYiRbMzETQ61W0oQx7tJJ1gcM+EI/qp9eSFf58aIbE2MlaBfkewTye1D8Wuof7QEsLzpGV/kK/WHv+nELPqFA==
---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: secrets
  namespace: home-automation
spec:
  encryptedData:
    home_city: AgDxfomNjO+lW5EGcOqNBJ2KqR0W+7c1Yl7lxR6g6V0E5IqvePDtNDbXbSUrCZ8qSaGHUfh53RC2gjEblFQwuts1lzNB2M6jOUSEkZWzTbBdz64GYuoC3dTmppgxR2P+IYmW3lStZBYNyH/uRmMn6GyQ4kC1Bjc+69vi+k011rkduOkMc3EvCnjgnZE7qekkb6i6dAAC/UTtLDtXq5MIfRNcfJuVqcRtUSaxZ0bss6jr8sRdQVD09xA2cmQbw8Haa2LokB91dOX9AaQqcjzYa+JGzCehlbWUeAlGEVUQThVLwfAzOcaJ+A2TNuhwNWRPsJdzF3tO/yD8uM1zYHtGBYNPfLBApOk7sZQ6nvaWbV2OZ0NelnptfJLuTkymwnSOT+iFqXIt6SUuR/TIn5dMi7dVZ+ICEqTAAs4whheXKFeIX3dMjUrwqnF6Ir/Ub95ELpUrIjAIrarrgdogT8J9pvzGT9w+FDOnlAx/NJ6APyjsSsbVSGpDgmG8difV6E/Z/V+UDJao6SrOy8n+FQRFnfHGZVmaIHk41tjXdCmOS4+4s1SRjI9QfTLejoE0W/54RXG5hAx2sWSECFikVOYtWKH9/C6FVz9jl1pllFRuCFMP/GCo1K/9Yiry8EkWiTk2BTm3YoFKpJ+3Ld8glvtS+T6peSZm17aGChcDb5GTxwmiIz8H3gqUDUeBupfUaW/xJgdLuWlyZ7dWYg==
    home_latitude: AgDuoj0W3qQqmb+erfWGTMMZz7sB14FGMWVodcnrHiDD663NjTmeUkr44NXJ6sPt9O4XpzsfEIV9yBJTJ30Rn1MVZJYPYd1ThSVKd0E/H4h6ok5c3lKMuizGyYGgKkWZmSHEevwI5BUaDHwHQLo9e6azMVbE6ptILb+bzDbDmTM3ofbM2cxXOip133c651RXU4XW1L9xxSWMxKST+ZmErpO9U4hHZlfn5yH609i/wvHIymkhQSux3eZ3srHqIlPmR1LdR3nQ2MO45+EG5G1jV+Knfa0zr/Z3EZdtZvg0i093JQ8crUJgGdhv+ZmEptMalqKkHU3TA60YRrwazzwZ6FkjqN7CNhwdhL4XnH1vP+P3K7K4r256mWqIjHaJDVNQtcN4ysgVfhHd0uGObvuEEJYDI9ScmKrIkiPJSoIkgTF+gn69OIgwRDWjg6ztcLdwmYG1AAR616vsB90LFwNHu3Gst1KRKTmXJhfwix2uFTes7ldefUmOPnZ8xr5ks56lYEBfIaZRd4ptyFXUQIWUw2AgLvgSAeu+rT3L83evpxqeKQhUYu3lygEX2igpuZmM2kmcb2D/L1AnKiptoIuCbqye0cndKTW55qvnP7nQLZBOcQZJMyIEp6umTk94IizBUOO8gY6o9YrdllVvUhR4augQfZ9KAivP8pbnLiAYLoYor8AGN1iEWJyvT1O7fklPMqRedMMtFomWsBjcZ80=
    home_longitude: AgC1CKF3RoEabM1uMtrhb5DKc6ko/BR2KtCJaTV8VUEIaQAjWsLM59bMm8hwFI6fn9jY0bcAaKYIptmgU+VLOa80DCkjGL5TSXH8xZhltV8opWlFjLj2n9wwFU6CiMzXWDmBZLjYl8HbPjsGKMNOnz/riw3ZlPJnNHaHDBO+hNpaXmhI70AhaD6HNnz9I4bg5BYVvlFVXe2YzPCQ9WIPykVlsfAWFqiFwNscU148cgtiIaF3DOZB7GyIZny1R6mb5hCPOLhzLzzWhyscH2AackbpdRMv2gwQf9H9vzXQP8Na362j/ah70ESZ5203wTxBZEfab86nEMgbiwN7oCygkOTQBNkP7PTTNp10+UmYrO6Q19t+GXYHaU+Qov1KebL2z0t4tWach5ARLjo9m/uEnTAwiPV9Eq01jTtJcsQU1ZCq0NYxGsquSE18xSM2OT7k2JbOMuOxedHY54cyht1YAP4BmhjXuVpaVpks5bX4o7z57LdOtGabmsgquC+O+qYFrEDif2NaZUWkhUdfaAHT20h7m5Ejz0blJts/DGuge9d793pKR66fbxt0LwLeaQd8oQ1uLE6b6K5/RWZr05BM3034VxrszQaLCqiW/XZwEPqzL7BQXtf9EZyFG9rpXHSmeLJLBBlfQnIfqJ7Kb27YS4cKhlB2fzV2EVPIXvOtnEYNQuWOnsOOH+3OgrucK9nWC+e4a8h8e7gd6+AbZZw=
    home_number: AgAOSBwWO0U74l0Pf9KLP1fGj7QeQFHN6Rr8B97q/AoD6EvOIfjy3ACXLRXCOPFLFhrZw7IAdlvzTZ3eQs7GNQABN4GQoFsI6fdLQOJSza6H1SelxKBZXo6yAv1rNDVPP7Aavy+u/TWHAvlDz3sk+p/8crLAxapCrrzRMq6JCuiw2EvreI/Som5eHPlU1GN8WSMlIqz6xACtUKoXdjNNf/6Ersse9ru8JM/ZmcisCQ2OXzLzjqxxI+EDsz8nGRePXgfu+9Z0fEtbCUi6gi9sWwvcjs1pJ6RWyBs/qMpsJ8hsM9drBZal9plBMidydATjqNaVCpG+HaERG6zHEGOVUfTLXZ6wlkGuVRRC2ggHplbwgMoK9m6eQVG3L3hgoicYacQ2oRpPi2SCd9J3w7lno8hiV9N7/mw4UZMbqSqjhajZd+aJi3N6qaA8+gZ5Bh9YEnsahjypoZqduWZpQKQUDni9mCRLSYQUuUdHqjDsF/F0BVsoCeh7g3Wk4yg3v+Y0RQ3bQ9I95RMsNtN3Re2Lytz6pj9e0P2NnzkvEa8y83gWlpdIJPCWTxw8LSmkL8U3jlA0ImJdmaM+7rWVCH7575QJ5OxQMvDt2AMY3ihJTJOjKqI/Kj6+6QJDyCIk7x3dPoWxV03J350gkwN5+VVm3qFwJXNq5jeh+cQCDJ7cgyrOBtNUsdDPXIyzwkac5hbb/zlECJYW
    home_zipcode: AgCrfCZm5wh3XiCXm9y5TGec/mKT8AIh0QTK4OokIo+xldaQLhIg9jaSlSyU8zv5KSbCmDcABaHeDZwuUU05twCqJ+wv1Rf+R9ZOxA3gdzi2vmunTwQfVz/GLv3HhsQtiTTYX6wuHs9pUqCxDxBW0M+qCeG0kFHp0DiGYq72VV/uj9TN9tCpcohETUvVwHa7K3Pi7uR2Cx8g823hrlsZ8m8fxfpuG5ooiWfMg+HBlz3U6BYl70bBpIvnYsE7UECAeaAoLqoUUElpjsbZbQCM8aAfy2qlc9JKjIxmBJ/AVVVsRfT98ifPsr9f/ex4Hq11TRSo+/pMhMYhWBOoFX5Y+XXw4CeePDnYtzOYq3sCuljMub/Q0FjuhFyBstn2tuQWf2fNegQs8/oqKgn4j8FjOOCse0n3N8u5/dpvT+Xmv9jVal0CtvMhDhbCCFvFNwZ80anjUKJwCRGdMZcmSLl7BkEYOLxyzhZCsERgZziQj1a1fkn3+uSRA18d2GtdWkcL++YD9OlO3A1ZX28dbTk3VUWAT+x2DxP/IWN5GkFDIgvK90fGo/399lnblJ5A+ikt1B5lMDDKjBopuKlosa/FsC46PpVs9422qxrDDJwqYFri5HAqqb75uyTBhP7qYe8TThYRrSVJpZFHm2tCdAKMZTBaOGoM4YRAhGAmi4XMFShKgrLX0lJK2NPMhQcW0hdKBPwiml/qkX4GCA==
    mysql-password: AgDkMOXq2OuWU3jzFdielwSWYYQkItUYe+2e7NweZWD7L3ZB5vPOC/6IcCgEfQ/l0TxNEEDK5fJIIYwqyZj+6fXAEh5qJcNUkhaaY52JQUv/0/2kcrQyEUU/atRPcwhMAMTpD+sIEb5Y3J9BFaH67jwvhiGgaq2g7KykTMqk4cG0/0Q1PlETp9FVDWa7hr2YtW7sEvb0IlLt9+7sWe4c8Gi/TfVGiLygsr/xLp1elPlTx058v+ipbCCEcck2A3UjmVIGLyvlbaESAZIxxGHHgw8kySAT5m2g3U4ycPGD2CInYK/DINYNVMuSUFExwFB17u69Rn7QEm1yUnoBiPs7KqqRRUpseywWnfq4M8+zpz/Fyc1Bn7drSPrddPk9BMIP5B8DAEV5F2U7WdGOdqMZ8ghdGhS/1OtH8lbRvD8nv2TiApU42AYHtbqn7b7LdT+yDxqgmQa8jIGh4MGentdoZUVGl35psr4lsvRfFYSMGR0NG8n8KrWxy3qygUgwH9NEq+bq9/lJfx/puWqgRN501Lde06izO8z4f26pBdaSQkrYep+ROBTmCD7HhGUVp7XJDqze/3UycapNH4QfvUu05RB64Wyr+JF3Z58FJZ87WjYAoENUtCm0BJSKNKmxDOwfMLjb13VQqB5ZQPTVsXAOAKxUs/mwcyhvd/6Ixrd8zt1846CnVPBGRM+oIXu/rziWdGyeI7P6Vn3E+ikkUZiglIHI3nwvs9/ikl1lK6BHRvlfCA==
    mysql-username: AgARrG44Zyn5LNz6Q3Z/fFyKoPEjaCQ24g8y32P/3WyCCB0nrMffwW6sXqoEHHqfo1LreHZtsml8gGta795BFfW2WkQaYJUBAWD3GHTh7autpESnDCH35VWNQBZPUnbEEVb+3R6xxMn4t4k8rBRt7C5hqWOYBPrkckPyoR8nyBWuU4ELB9MS1pj2hTnJv3Mb7PGSNi+0Cl/1nRuvZPXVTrV4XCMv09tG2iB3xK7lxxWdCH6MhXLqZeVC8jaM/TcYEzxFjGR6OjWLRU90aPgJSRrtoyNUrzhtDOesYZT9EL9sr4a+6dVgUmo9EyDn7VxSDHG9Bb+gBHoUSw8CSfa6z7EKCuzDRlhdhtbdT3eLhX1OIrRkmyTHEMG2ItmC/yQPQ32KS82E6yLv0MlSQ0EWo7bHJojqyKXOUxDk37edNZxVdv+8sbM2hm3lur5VxLKn9OOy1m4Z7LPw7OVIHqIAeW+FkIFWdwDAK/8gbPMMkq40MWg+voRqn/+8gpi9OXKaXIn8FWeaQAC9m2b/HunBY8KWviUkT8nkwYMMv9tOdqPvBYgjDXhGeKbPJ37vHMduHzbimT/IKGayt5paUNg5QoC50pFVuu3ALCuIXYesVQyOrXfKbTs2VUB2Br+d1YksKdwZBBhEZAMRdgdAzyscgvQ1ir+lpwWFg+Geb6HS6b628HDJAn4DLmW+sPaHNVACyeGLy2OmobcSbMK9dAaQhMRouSsHWw==
    xiaomi_cloud_password: AgB3/CL/ITTHkIYraQifkER+5ens1OoX1dKnHYjnLd/+w+fsLw736Qu6bv9qiBtyg3hAyk8pCYX46UzEmLJ3kzdoNqsAD7C35j94LxGYUOpqc++8XLUMyosbhS7hUFbK16Eg8RZabZq1wa7mepEIpNSulkZsStLkXM/lsgQ5SMBRkH2aI6H+ZlVUQ69SLrVI9O6MJ2JFhUyFfgRrqsXZS9CH67r/arEykMS0/1ZSE5mzFmJ1F6NgqedtxBDmC2RA53MDhZ/CTJWZT46KVP0S4U4w296MoAHyuZxSwRCknIrl7g5tUHBt266d20HvAs5e9Q2zfxPRL2MRy9FJgJes+LCXiRrsL8f7KLGkbDV8NH1B5FFpWx6ipy79v/m80VX61BoBbwj4QbM9PLf6CtZNPZYPGO+POnmvmfMiexzPg156PvIYwgSjXTEnkiS4ATp+yz4yDAUtI0HGiInOEICRFHs3AuZJxt7ck9CuK2ybOkYERFednRW2SLls3Kn2Ye65Rlsq/UqQ4eQs5Nvh1IovwRtl/PBNtkIuI/XZDzlYARGLhrASNClnQPekg+2ULjLsXEcPoKvshI2GFTcqLXG8xfdDVMCiVqbehAF93Wv6XXuvKQ9xdLEOetlHeSgTG+hy70FevjKWtiGAYLpgDwGGf+SwXGZKbjxf2kugebx6Qka1HqdE91mF9feaJXfwHHzinCJPvflKOzXGPHBgcaBVX0H09vLI+FbeVvM=
    xiaomi_cloud_username: AgDLe3RZ6pP+KV+vg7La9cG1hl2JZq8LSiXfg2Xg1AtJXq+9MjOoiZChWP5PvaZv8xG65Js62QvY2jGfAcrJ+5lZXXh0S0d5sk5uwIrHATs4aPfbAM89febbE/CQ+ZLlMcGEpn0+fPcExz1HRGivoWuect+aBrMeRg1Y0XpPKR47oGiFvjAVDFfANEMNsWHgDLrR96kWDBPx0LTVNkSB7rGlZORpngrpAgswvv5utrEgHKhLLHNHCDpTi2xnAvbX/224rM+qsb3Y73R0SSglLbZ3oitQE4JnEg3p/xFUhAx80/TzPRsoVI94myDrnFm0HkmBLFeE7Gjkg5wG9s/mqBUkTwqgLq2zMEyyDkfXyMzPpM4m3fya/+AYUQndBWVDEw75meqjTtICqMlFbwXmTZrS9+zekjIVShzlt2ws+dKBpPx2Ygm+IWS4s9uG9rWS/lTS8mBva+100QmXh1+PjjyUkvUQBFo64Yokx07dazMqtKQa/UNc+W7bziUL6NB2pJPXOmhcdg3RoMmLHlSjDliiB/KnOMNn81TpgVemuM9TsHRqfQJKsaMh3zsWDgZBnE3KTn/6PQP3uJC1iJfA9XPKBFRuzCIQ5YMZdsfz+gONds7ps+S0QGTx180bupQ9+mpylx5BKOP0SCW+T7ftO4GW7cwdntrkXRRcaDUi4PF7ApGd6yxHTgrukYiB4RR3jL2KXeKoB+Jblo0agQj/Bb6sUTOkDrO0gmM=
    xiaomi_vacuum_s6_token: AgDItq38O3nwDuuvxV3iDlOUcR83qri7mdfsM982zrc/EzOpICi/MZK57T2QVfHj4qk2jO25iKBLh9nRE7++XJCwAIARjfF8DfxOqj9MX9jnlN0yXP1fz8AeY0VLGxhB1PdujD5jADMgFqZjVY7E91jD625o/QycVMGQa5aygfmr3iafdqhBn2KCOJ5XD1GgSeWcg2BqfW1lvrJ3yybbANQWbm2HKfw/3lt1eEJjn8O629SWAeMB9XfxnSJ3nyM1QZ0UWzu/ErTPLLb0410PdX1qssNIBL4uQM6LarlcHOKlcujtIIwfpYTijEDn2RmsJLoBFn8q9ZvBCu5u00nBqGURNZrNjCDwT9lvzibJe2LyNVpCQLHssJKcPWagjjgjtZEovOcxr+vo+XwwjeZQ+NJMEsbU/zmu8eLIEo1YNi51kT63MfKpkQaI2SJIhWirg0ZWgwdgmb4YUUM5dLPNqNZ7tfpHKdaNOmD3E9xaiyS51N8ybikZkwuwpTHmMoxwbvPFeLVxqYOtlGMXojTBtbSc1k9Vh7g5ty/K3RmXIwYGojNSOX3MIYi7WpfKaMJU63NEK7CDwUk3gwbDKE0XUw3trQBqxC2kAcZJWPYNWYrQAWX67743VqcyZ9rh305611s2fq2KeOuSH4QIbX5Q7cyb7s4ywCQBk1w4SNKZTBEewrxEi5JkIT2wf6g2z/KEbERL5xVMZGYyaV+RaZo+z2PUFAGEvepdyrZ1nK4NV1zbLO9o9FiuxY93Yi0mUw==
  template:
    data:
      secrets.yaml: |-
        db_url: mysql://{{ index . "mysql-username" }}:{{ index . "mysql-password" }}@home-assistant-mysql.home-automation.svc.cluster.local/home-assistant?charset=utf8mb4
        home_zipcode: {{ index . "home_zipcode" }}
        home_number: {{ index . "home_number" }}
        home_city: {{ index . "home_city" }}
        home_latitude: {{ index . "home_latitude" }}
        home_longitude: {{ index . "home_longitude" }}
        nvidia_shield_ip: 192.168.30.60
        xiaomi_cloud_password: {{ index . "xiaomi_cloud_password" }}
        xiaomi_cloud_username: {{ index . "xiaomi_cloud_username" }}
        xiaomi_vacuum_s6_token: {{ index . "xiaomi_vacuum_s6_token" }}
        proxmox_host: test
        proxmox_username: test
        proxmox_password: test
    metadata:
      labels:
        app.kubernetes.io/name: home-assistant
      name: secrets
      namespace: home-automation
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: shelly-script
  namespace: home-automation
data:
  shelly-script.sh: |
    ip_subnet="192.168.40"
    ip_start="99"
    ip_end="140"
    ip=$(hostname -I | cut -d' ' -f1)
    for i in $(seq ${ip_start} ${ip_end}); do curl -v -m 2 "http://${ip_subnet}.${i}/settings?coiot_enable=true&coiot_peer=${ip}" 2>/dev/null && curl -v -m 2 "http://${ip_subnet}.${i}/reboot" 2>/dev/null; done

---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: home-assistant-mysql
  namespace: home-automation
  labels:
    app: home-assistant
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: home-assistant-mysql
  template:
    metadata:
      labels:
        app: home-assistant-mysql
    spec:
      containers:
        - name: home-assistant-mysql
          image: mysql:8.0.28
          resources: {}
          ports:
            - containerPort: 3306
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: home-assistant-mysql-secrets
                  key: mysql-password
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: home-assistant-mysql-secrets
                  key: mysql-username
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: home-assistant-mysql-secrets
                  key: mysql-password
            - name: MYSQL_DATABASE
              value: home-assistant
          volumeMounts:
            - name: home-assistant-db
              mountPath: /var/lib/mysql
      volumes:
        - name: home-assistant-db
          persistentVolumeClaim:
            claimName: pvc-iscsi-home-assistant-db
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: home-assistant
  namespace: home-automation
  labels:
    app: home-assistant
spec:
  replicas: 1
  selector:
    matchLabels:
      app: home-assistant
  template:
    metadata:
      labels:
        app: home-assistant
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      initContainers:
        - name: init-01-home-assistant
          image: "harbor.k8s.lan/library/init-01-home-assistant:8"
          command: ["sh", "-c", "/script/shelly-script.sh"]
          volumeMounts:
            - name: shelly-script
              mountPath: /script/shelly-script.sh
              subPath: shelly-script.sh
      containers:
        - name: home-assistant
          image: "harbor.k8s.lan/library/home-assistant:8"
          imagePullPolicy: Always
          resources: {}
          securityContext:
            privileged: true
          ports:
            - containerPort: 8123
          env:
            - name: TZ
              value: "Europe/Amsterdam"
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
          livenessProbe:
            httpGet:
              path: /manifest.json
              port: 8123
          readinessProbe:
            httpGet:
              path: /manifest.json
              port: 8123
          volumeMounts:
            - name: home-assistant-config
              mountPath: /config/.storage
            - name: secrets
              mountPath: /config/secrets.yaml
              subPath: secrets.yaml
      volumes:
        - name: home-assistant-config
          persistentVolumeClaim:
            claimName: pvc-nfs-home-assistant-config
        - name: shelly-script
          configMap:
            name: shelly-script
            defaultMode: 0777
        - name: secrets
          secret:
            secretName: secrets
      imagePullSecrets:
        - name: container-image-registry-credentials
---
kind: Service
apiVersion: v1
metadata:
  name: home-assistant-mysql
  namespace: home-automation
  labels:
    app: home-assistant
spec:
  selector:
    app: home-assistant-mysql
  type: ClusterIP
  ports:
    - port: 3306
      protocol: TCP
---
kind: Service
apiVersion: v1
metadata:
  name: home-assistant
  namespace: home-automation
  labels:
    app: home-assistant
spec:
  selector:
    app: home-assistant
  type: ClusterIP
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 8123
---
kind: Ingress
apiVersion: networking.k8s.io/v1
metadata:
  name: home-assistant-private
  namespace: home-automation
  labels:
    app: home-assistant
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx-private
  rules:
    - host: home-assistant.k8s.lan
      http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: home-assistant
                port:
                  number: 80
  tls:
    - hosts:
        - home-assistant.k8s.lan
      secretName: tls-wildcard-k8s-lan
---
kind: Ingress
apiVersion: networking.k8s.io/v1
metadata:
  name: home-assistant-public
  namespace: home-automation
  labels:
    app: home-assistant
  annotations:
    nginx.ingress.kubernetes.io/from-to-www-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx-public
  rules:
    - host: "home-assistant.theautomation.nl"
      http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: home-assistant
                port:
                  number: 80
  tls:
    - hosts:
        - home-assistant.theautomation.nl
      secretName: cloudflare-tls
