---
kind: pipeline
name: validate

steps:
  - name: lint
    image: sdesbure/yamllint:latest
    commands:
      - yamllint -c ./.yamllint .

---
kind: pipeline
name: test

steps:
  - name: stable
    image: homeassistant/home-assistant:stable
    pull: always
    commands:
      - mv config/secrets.yaml.example config/secrets.yaml
      - python -m homeassistant --script check_config --config ./config/

  - name: dev
    image: homeassistant/home-assistant:dev
    pull: always
    failure: ignore
    commands:
      - python -m homeassistant --script check_config --config ./config/

  - name: rc
    image: homeassistant/home-assistant:rc
    pull: always
    failure: ignore
    commands:
      - python -m homeassistant --script check_config --config ./config/

---
kind: pipeline
type: docker
name: upgrade

depends_on:
  - validate
  - test

steps:
  - name: cleanup
    image: appleboy/drone-ssh
    settings:
      host: docker.stam.lan
      username: coen
      password:
        from_secret: ssh_password
      port: 22
      script:
        - cd /home/coen/docker-home-services/prd-home-assistant-config
        - docker image prune -f
        - docker container prune -f

  - name: git pull
    image: appleboy/drone-ssh
    settings:
      host: docker.stam.lan
      username: coen
      password:
        from_secret: ssh_password
      port: 22
      script:
        - cd /home/coen/docker-home-services/prd-home-assistant-config
        - git pull

---
kind: pipeline
type: docker
name: deploy

depends_on:
  - upgrade

steps:
  - name: deploy containers
    image: appleboy/drone-ssh
    settings:
      host: docker.stam.lan
      username: coen
      password:
        from_secret: ssh_password
      port: 22
      script:
        - cd /home/coen/docker-home-services/prd-home-assistant-config
        - docker-compose down
        - docker-compose up -d
